<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Labirintas</title>
    <style type="text/css">
        * {
            margin: 10px;
            padding: 0;
            outline: none;
            font-family: 'Segoe UI', sans-serif;
        }

        html {
            margin: 0;
        }

        canvas {
            display: inline-block;
            border: 1px solid #999;
            border-radius: 5px;
            position: absolute;
            left: 0px;
            top: 55px;
        }

        canvas.error {
            background: rgba(255, 0, 0, 0.25);
        }

        ::selection {
            background: transparent;
        }

        #eraser.active {
            background: rgba(175, 200, 150, .5);
        }

        #eraser {
            border-radius: 64px;
            padding: 4px 7px;
            background: rgba(175, 200, 150, .2);
        }

        #eraser img {
            padding: 0;
            margin: 0;
        }

        canvas.erasing {
            cursor: crosshair;
        }

        #dice {
            font-size: 24px;
        }

        nav {
	        margin-top: 0;
            text-align: center;
        }

        #forget {
            background: url(https://cdn4.iconfinder.com/data/icons/meBaze-Freebies/512/reload.png);
            background-size: 50px 50px;
            height: 50px;
            width: 50px;
            display: inline-block;
            position: absolute;
            z-index: 1000;
            margin: 0;
            transition: 1s linear;
        }

        #forget:hover {
            filter: drop-shadow(0 0 10px #43C6F0);
            transform: rotate(30deg);
            transition: 0.5s linear;
        }

        #turtle-canvas {
            z-index: 1000;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
			integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			crossorigin="anonymous"></script>
</head>
<body>
    <a href="#" id="forget"></a>
    <nav>
        Veiksmas:
        <select id="action" style="width: 150px;">
            <option value="">Jokio</option>
            <option value="‚û†">Pirmyn</option>
            <option value="‚Ü∑">Suktis pagal laikrod≈æio rodyklƒô</option>
            <option value="‚Ü∂">Suktis prie≈° laikrod≈æio rodyklƒô</option>
            <option value="üé≤">Mesti kauliukƒÖ</option>
            <option value="üö©">Pa≈æymƒóti</option>
            <option value="üòã">Suvalgyti</option>
        </select>
        Rodyklƒó:
        <select id="conditioning" style="width: 150px;">
            <option value="">BesƒÖlygi≈°ka</option>
            <option value="Obstacle">Tik prie≈°ais kli≈´tƒØ</option>
            <option value="Path">Tik prie≈°ais keliƒÖ</option>
            <option value="Food">Tik ant maisto</option>
            <option value="Flag">Tik ant ≈æymƒós</option>
            <option value="0">Tik jei i≈°kritusi 1 akis</option>
            <option value="1">Tik jei i≈°kritƒô 2 akys</option>
            <option value="2">Tik jei i≈°kritƒô 3 akys</option>
            <option value="3">Tik jei i≈°kritƒô 4 akys</option>
            <option value="4">Tik jei i≈°kritƒô 5 akys</option>
            <option value="5">Tik jei i≈°kritƒô 6 akys</option>
            <option value="Else">Jei jokia kita rodyklƒó netinka</option>
        </select>
        <a id="eraser" href="#"><img src="https://d30y9cdsu7xlg0.cloudfront.net/png/3715-200.png" alt="Trintukas" title="Trintukas" width="16" height="16"></a>
        Lƒótinimas, ms:
        <input type="number" id="speed" value="1000" style="width: 4em;">
        Kauliukas:
        <span id="dice">‚öÄ</span>
    </nav>
    <main>
        <canvas id="turtle-canvas" height="200" width="200"></canvas>
        <canvas id="canvas" height="350" width="1000"></canvas>
    </main>
    <script type="text/javascript">
        var canvas = document.getElementById('canvas');
        var turtleCanvas = document.getElementById('turtle-canvas');
        var ctx = canvas.getContext('2d');
        var bubbles = [];
        var dragging = false;
        var source = null;
        var target = null;
        var lines = [];
        var label = '';
        var origin = null;
        var time;
        var turtle = {x: 4, y: 2, direction: 2};
        var directions = [
            {x: 1, y: 0},
            {x: 0, y: 1},
            {x: -1, y: 0},
            {x: 0, y: -1}
        ];
        var arrows = ['‚ñº', '‚ñ∂', '‚ñ≤', '‚óÄ'];
        var env = [
            '##########',
            '#...#...F#',
            '#...#....#',
            '#...#....#',
            '#...#....#',
            '#...###..#',
            '#.....#..#',
            '#.#####..#',
            '#........#',
            '##########'
        ];
        var eaten = false;
        var flagged = [
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false]
        ];
        var grid = [];
        var speed = 1000;

        var admits = function(condition) {
            var x = turtle.x;
            var y = turtle.y;
            var xx = x + directions[turtle.direction].x;
            var yy = y + directions[turtle.direction].y;
            var result =
                (condition == '') ||
                (condition == 'Path' && grid[xx][yy] != '#') ||
                (condition == 'Food' && env[x][y] == 'F' && !eaten) ||
                (condition == 'Obstacle' && grid[xx][yy] == '#') ||
                (condition == 'Flag' && flagged[x][y]) ||
                (condition == dice);
            return result;
        };

        var dice = 0;
        var diceFaces = '‚öÄ‚öÅ‚öÇ‚öÉ‚öÑ‚öÖ';

        var erasing = false;

        document.getElementById('eraser').addEventListener('click', function(event) {
            event.preventDefault();
            var eraser = document.getElementById('eraser');
            if (!erasing) {
                stopExecution();
                eraser.setAttribute('class', 'active');
                canvas.setAttribute('class', 'erasing');
                erasing = true;
            } else {
				stopErasing();
            }
        });

		var stopErasing = function() {
			erasing = false;
			canvas.setAttribute('class', '');
			eraser.setAttribute('class', '');
		};

        var rollDice = function() {
            dice = parseInt(Math.random() * 6);
            document.getElementById('dice').innerHTML = diceFaces[dice];
        };

        var commands = function(all) {
            if (all.length == 0) {
                return;
            }
            for (k in all) {
                var c = all[k];
                if (c == '‚û†') {
                    turtle.x += directions[turtle.direction].x;
                    turtle.y += directions[turtle.direction].y;
                }
                if (c == '‚Ü∑') {
                    turtle.direction = (turtle.direction + 3) % 4;
                }
                if (c == '‚Ü∂') {
                    turtle.direction = (turtle.direction + 1) % 4;
                }
                if (c == 'üé≤') {
                    rollDice();
                }
                if (c == 'üö©') {
                    flagged[turtle.x][turtle.y] = true;
                }
                if (c == 'üòã') {
                    if (env[turtle.x][turtle.y] != 'F' || eaten) {
                        window.alert('ƒåia ne maistas!');
                    } else {
                        eaten = true;
                        window.alert('Om nom nom. Puikiai padirbƒójote!');
                    }
                }
            }
            drawTurtle();
        };

        var drawTurtle = function() {
            grid = [];
            for (k in env) {
                grid.push([]);
                for (j in env[k]) {
                    grid[k].push(env[k][j]);
                }
            }
            if (env[turtle.x][turtle.y] == '#') {
                turtle.x -= directions[turtle.direction].x;
                turtle.y -= directions[turtle.direction].y;
                window.clearInterval(execution);
                endPulsation();
                clear();
                drawBubbles();
                window.alert('Atsitrenkƒóte ƒØ sienƒÖ!');
            }
            grid[turtle.x][turtle.y] = 'T';
            drawGrid();
        };

        var drawGrid = function() {
            var tctx = turtleCanvas.getContext('2d');
            tctx.clearRect(0, 0, 200, 200);
            var x = 0, y = 0;
            for (k in grid) {
                x = 0;
                for (j in grid[k]) {
                    switch (grid[k][j]) {
                        case '#':
                            tctx.fillStyle = '#740';
                            break;
                        case '.':
                            tctx.fillStyle = '#380';
                            break;
                        case 'T':
                            tctx.fillStyle = (env[k][j] == 'F' && !eaten) ? '#CC0' : '#380';
                            break;
                        case 'F':
                            tctx.fillStyle = !eaten ? '#CC0' : '#380';
                            break;
                    }
                    tctx.fillRect(x, y, 20, 20);
                    if (flagged[k][j]) {
                        tctx.fillStyle = 'white';
                        tctx.font = '15px sans-serif';
                        tctx.fillText('üö©', x, y + 17);
                    }
                    if (grid[k][j] == 'T') {
                        tctx.fillStyle = 'white';
                        tctx.font = '20px sans-serif';
                        tctx.fillText(arrows[turtle.direction], x, y + 17);
                    }
                    x += 20;
                }
                y += 20;
            }
        };

        var drawLine = function(source, target, condition) {
            if (condition == '(Erased)') {
                return;
            }
            ctx.beginPath();
            var d = {x: bubbles[target].x - bubbles[source].x, y: bubbles[target].y - bubbles[source].y};
            var dl = Math.sqrt(Math.pow(d.x, 2) + Math.pow(d.y, 2));
            d.x /= dl;
            d.y /= dl;
            ctx.strokeStyle = '#999';
            ctx.moveTo(bubbles[source].x + d.x * bubbles[source].radius, bubbles[source].y + d.y * bubbles[source].radius);
            ctx.lineTo(bubbles[target].x - d.x * (bubbles[target].radius + 15), bubbles[target].y - d.y * (bubbles[target].radius + 15));
            ctx.stroke();
            ctx.beginPath();
            ctx.save();
            ctx.translate(bubbles[target].x - d.x * bubbles[target].radius, bubbles[target].y - d.y * bubbles[target].radius);
            ctx.rotate(Math.atan(d.y / d.x) + ((d.x >= 0) ? 90 : -90) * Math.PI / 180);
            ctx.moveTo(0, 0);
            ctx.lineTo(5, 15);
            ctx.lineTo(-5, 15);
            ctx.closePath();
            ctx.restore();
            ctx.fillStyle = '#999';
            ctx.fill();
            var x = parseInt((bubbles[source].x + bubbles[target].x) / 2);
            var y = parseInt((bubbles[source].y + bubbles[target].y) / 2);
            if (condition == 'Obstacle' || condition == 'Path' || condition == 'Food') {
                ctx.fillStyle = {'Obstacle': '#740', 'Path': '#380', 'Food': '#CC0'}[condition];
                ctx.fillRect(x - 10, y - 10, 20, 20);
            }
            if (condition == '0' || parseInt(condition) > 0) {
                ctx.fillStyle = '#CCC';
                ctx.fillRect(x - 10, y - 10, 20, 20);
                ctx.font = '20px sans-serif';
                ctx.fillStyle = '#333';
                ctx.fillText(diceFaces[parseInt(condition)], x, y + 7);
            }
            if (condition == 'Flag') {
                ctx.font = '15px sans-serif';
                ctx.fillText('üö©', x, y + 5);
            }
            if (condition == 'Else') {
                ctx.font = '40px bold sans-serif';
                ctx.fillStyle = '#802ab2';
                ctx.fillText('*', x, y + 20);
            }
        };

        var mouseUp = function(event) {
            event.preventDefault();
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            stopErasing();
            if (Date.now() - time > 750 && Math.sqrt(Math.pow(origin.x - event.pageX, 2) + Math.pow(origin.y - event.pageY, 2)) < 50) {
                execute(locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop));
                return false;
            }
            if (dragging) {
                target = null;
                target = locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop);
                if (target !== null && target != source) {
                    drawLine(source, target, document.getElementById('conditioning').value);
                    lines.push([source, target, document.getElementById('conditioning').value]);
                }
            }
            source = null;
            target = null;
            dragging = false;
            return false;
        };

        var lastVirtualMouseDown = 0;

        var mouseMove = function(event) {
            event.preventDefault();
            if (dragging && erasing && Date.now() - lastVirtualMouseDown > 250) {
                mouseDown(event);
                lastVirtualMouseDown = Date.now();
            }
            return false;
        };

        var drawBubbles = function(selection) {
            if (validateConnections(false)) {
                cleanUp();
            }
            for (var j in bubbles) {
                if (bubbles[j].color == 'transparent') {
                    continue;
                }
                ctx.beginPath();
                ctx.ellipse(bubbles[j].x, bubbles[j].y, bubbles[j].radius, bubbles[j].radius, 0, 0, 2 * Math.PI);
                //ctx.rect(bubbles[j].x - 25, bubbles[j].y - 25, 50, 50);
                ctx.fillStyle = bubbles[j].color.replace('?', selection == j ? '0.9' : '0.3');
                ctx.fill();
                ctx.font = '22px sans-serif';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                ctx.textAlign = 'center';
                ctx.fillText(bubbles[j].label, bubbles[j].x, bubbles[j].y + 7);
            }
            for (var j in lines) {
                drawLine(lines[j][0], lines[j][1], lines[j][2]);
            }
        };

        var shouldInhibitSpawning = function(x, y) {
            for (var k in bubbles) {
                if (Math.pow(bubbles[k].x - x, 2) + Math.pow(bubbles[k].y - y, 2) <= Math.pow(bubbles[k].radius + 25, 2)) {
                    return true;
                }
            }
            return false;
        };

        var locate = function(x, y) {
            for (var k in bubbles) {
                if (Math.pow(bubbles[k].x - x, 2) + Math.pow(bubbles[k].y - y, 2) <= Math.pow(bubbles[k].radius + 10, 2)) {
                    return k;
                }
            }
            return null;
        };

        var locateArrow = function(mx, my) {
            for (var k in lines) {
                if (lines[k][2] == '(Erased)') {
                    continue;
                }
                var source = bubbles[lines[k][0]];
                var target = bubbles[lines[k][1]];
                var direction = {x: target.x - source.x, y: target.y - source.y};
                var x = source.x;
                var y = source.y;
                for (var f = 0; f <= 1; f += 0.001) {
                    x += direction.x * 0.001;
                    y += direction.y * 0.001;
                    if (Math.abs(mx - x) < 10 && Math.abs(my - y) < 10) {
                        return k;
                    }
                }
            }
            return null;
        };

        var clear = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        var mouseDown = function(event) {
            event.preventDefault();
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            clear();
            origin = {x: event.pageX, y: event.pageY};
            time = Date.now();
            var x = event.pageX - canvas.offsetLeft;
            var y = event.pageY - canvas.offsetTop;
            var selection = locate(x, y);

            if (erasing) {
                if (selection === null) {
                    var arrow = locateArrow(x, y);
                    if (arrow !== null) {
                        lines[arrow][2] = '(Erased)';
                    }
                } else {
                    bubbles[selection].color = 'transparent';
                }
            } else {
				if (selection === null || bubbles[selection].color == 'transparent') {
					if (!shouldInhibitSpawning(x, y) || (selection !== null && bubbles[selection].color == 'transparent')) {
						var color = 'rgba(150, 175, 200, ?)';
						var newBubble = {x: event.pageX - canvas.offsetLeft, y: event.pageY - canvas.offsetTop, radius: 25, color: color, label: label};
						if (selection === null) {
							bubbles.push(newBubble);
							selection = bubbles.length - 1;
						} else {
							bubbles[selection] = newBubble;
						}
					}
				}
			}
            drawBubbles(selection);
            dragging = true;
            source = selection;
            return false;
        };

        canvas.addEventListener('mousedown', mouseDown);
        canvas.addEventListener('touchstart', mouseDown);

        canvas.addEventListener('mouseup', mouseUp);
        canvas.addEventListener('touchend', mouseUp);

        canvas.addEventListener('mousemove', mouseMove);
        canvas.addEventListener('touchmove', mouseMove);

        var growing;
        var shrinking;

        var beginPulsation = function(ids) {
            for (k in ids) {
                endPulsation(ids[k]);
            }
            if (ids.length == 0) {
                return;
            }
            var grow = function() {
                for (k in ids) {
                    var id = ids[k];
                    bubbles[id].radius += 1;
                    if (bubbles[id].radius > 35) {
                        window.clearInterval(growing);
                        shrinking = window.setInterval(shrink, 20);
                        break;
                    }
                }
                clear();
                drawBubbles();
            };
            var shrink = function() {
                for (k in ids) {
                    var id = ids[k];
                    bubbles[id].radius -= 1;
                    if (bubbles[id].radius < 25) {
                        window.clearInterval(shrinking);
                        growing = window.setInterval(grow, 20);
                        break;
                    }
                }
                clear();
                drawBubbles();
            };
            growing = window.setInterval(grow, 10);
        };

        var endPulsation = function() {
            for (var k in bubbles) {
                bubbles[k].radius = 25;
            }
            window.clearInterval(growing);
            window.clearInterval(shrinking);
        };

        var currentStates = [];

        var execution;

            var validateConnections = function(warn) {
                for (k in lines) {
                    if (lines[k][2] == '(Erased)') {
                        continue;
                    }
                    var source = bubbles[lines[k][0]];
                    var target = bubbles[lines[k][1]];
                    if (source.color == 'transparent' || target.color == 'transparent') {
                        if (warn) {
                            window.alert('Yra rodykli≈≥, nevedanƒçi≈≥ niekur!');
                        }
                        return false;
                    }
                }
                return true;
            };

            var cleaningUp = false;

            var cleanUp = function() {
                if (cleaningUp) {
                    return;
                }
                cleaningUp = true;
                var lineErased;
                do {
                    lineErased = false;
                    for (k in lines) {
                        if (lines[k][2] == '(Erased)') {
                            var last = lines.length - 1;
                            lines[k] = [lines[last][0], lines[last][1], lines[last][2]];
                            lines.pop();
                            lineErased = true;
                            break;
                        }
                    }
                } while (lineErased);
                var count = 0;
                var holeFound;
                do {
                    count++;
                    if (count > 1000) {
                        console.log(bubbles, lines);
                        console.log('FROWNY FACE');
                        break;
                    }
                    holeFound = false;
                    for (k in bubbles) {
                        if (bubbles[k].color == 'transparent') {
                            var last = bubbles.length - 1;
                            for (j in lines) {
                                if (lines[j][0] == last) {
                                    lines[j][0] = k;
                                }
                                if (lines[j][1] == last) {
                                    lines[j][1] = k;
                                }
                            }
                            bubbles[k] = {x: bubbles[last].x, y: bubbles[last].y, radius: bubbles[last].radius, color: bubbles[last].color, label: bubbles[last].label};
                            bubbles.pop();
                            holeFound = true;
                            break;
                        }
                    }
                } while (holeFound);
                cleaningUp = false;
            };

        var execute = function(id) {
            if (!validateConnections()) {
                return;
            }
            cleanUp();
            window.clearInterval(execution);
            currentStates = [[id, '']];
            var doExecution = function() {
                endPulsation();
                var admissibleStates = [];
                for (k in currentStates) {
                    if (bubbles[currentStates[k][0]].color != 'transparent' && admits(currentStates[k][1])) {
                        admissibleStates.push(currentStates[k][0]);
                    }
                }
                if (admissibleStates.length == 0) {
                    var catchAll = null;
                    for (k in currentStates) {
                        if (bubbles[currentStates[k][0]].color != 'transparent' && currentStates[k][1] == 'Else') {
                            catchAll = currentStates[k][0];
                            break;
                        }
                    }
                    currentStates = (catchAll !== null) ? [catchAll] : [];
                } else {
                    currentStates = admissibleStates;
                }
                if (currentStates.length > 1) {
                    //canvas.setAttribute('class', 'error');
                    clear();
                    drawBubbles();
                    window.clearInterval(execution);
                    window.alert('≈†iame u≈æsiƒómime nƒóra paralelizmo, todƒól paspaudimas negali persiduoti keliems mygtukams i≈° karto.');
                    return;
                }
                if (currentStates.length == 0) {
                    clear();
                    drawBubbles();
                    window.clearInterval(execution);
                    return;
                }
                var futureStates = [];
                beginPulsation(currentStates);
                var cmds = [];
                for (k in currentStates) {
                    cmds.push(bubbles[currentStates[k]].label);
                    for (j in lines) {
                        if (lines[j][0] === currentStates[k]) {
                            futureStates.push([lines[j][1], lines[j][2]]);
                        }
                    }
                }
                commands(cmds);
                currentStates = futureStates;
            };
            doExecution();
            execution = window.setInterval(doExecution, speed);
        };

        canvas.addEventListener('dblclick', function(event) {
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            execute(locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop));
            return false;
        });

        var action = document.getElementById('action');

        action.addEventListener('change', function() {
            label = action.value;
        });

        var speedSwitch = document.getElementById('speed');

        speedSwitch.addEventListener('blur', function() {
            speed = parseInt(speedSwitch.value);
        });

        var stopExecution = function() {
            window.clearInterval(execution);
            endPulsation();
            clear();
            drawBubbles();
        };

        document.addEventListener('keypress', function(event) {
            if (event.which == 27) {
                event.preventDefault();
                stopExecution();
            }
        });

        document.getElementById('action').value = '';
        document.getElementById('conditioning').value = '';

        var store = function() {
            console.log('Begin storing');
            window.localStorage.setItem('maze:timestamp', JSON.stringify(Date.now()));
            window.localStorage.setItem('maze:bubbles', JSON.stringify(bubbles));
            window.localStorage.setItem('maze:lines', JSON.stringify(lines));
            window.localStorage.setItem('maze:turtle', JSON.stringify(turtle));
            window.localStorage.setItem('maze:eaten', JSON.stringify(eaten));
            window.localStorage.setItem('maze:flagged', JSON.stringify(flagged));
            window.localStorage.setItem('maze:speed', JSON.stringify(speed));
            console.log('End storing');
        };

        var fetch = function() {
            if (window.localStorage.getItem('maze:timestamp')) {
                bubbles = JSON.parse(window.localStorage.getItem('maze:bubbles'));
                lines = JSON.parse(window.localStorage.getItem('maze:lines'));
                turtle = JSON.parse(window.localStorage.getItem('maze:turtle'));
                eaten = JSON.parse(window.localStorage.getItem('maze:eaten'));
                flagged = JSON.parse(window.localStorage.getItem('maze:flagged'));
                speed = JSON.parse(window.localStorage.getItem('maze:speed'));
                speedSwitch.value = speed;
            }
        };

        var forget = function() {
            window.localStorage.removeItem('maze:timestamp');
            window.removeEventListener('beforeunload', store);
            window.location.reload();
        };

        window.fetch();
        window.setInterval(store, 15000);
        window.addEventListener('beforeunload', store);

        $(window).resize(function() {
            $('#canvas')[0].width = Math.max(1000, $(window).width() - 20);
            $('#canvas')[0].height = Math.max(350, $(window).height() - 85);
            $('#forget').css({left: $(window).width() - 70, top: $(window).height() - 80});
            try {
                drawBubbles();
                drawTurtle();
            } catch (e) {
                window.alert('Nepavyko atkurti aplinkos.');
                forget();
            }
        }).trigger('resize');

        $('#forget').click(function(event) {
            event.preventDefault();
            if (window.confirm('Ar norite atkurti aplinkƒÖ ƒØ tokiƒÖ, kokia ji buvo i≈° prad≈æi≈≥?')) {
                forget();
            }
        });

    </script>
</body>
</html>
