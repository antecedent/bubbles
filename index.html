<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style type="text/css">
        * {
            margin: 10px;
            padding: 0;
        }

        canvas {
            display: inline-block;
            border: 1px solid #999;
            border-radius: 5px;
        }

        canvas.error {
            background: rgba(255, 0, 0, 0.25);
        }

        ::selection {
            background: transparent;
        }

        #turtle-canvas {
            position: absolute;
            left: 20px;
            top: 59px;
        }
    </style>
</head>
<body>
    Veiksmas:
    <select id="action">
        <option value="">Jokio</option>
        <option value="➠">Pirmyn</option>
        <option value="↷">Suktis pagal laikrodžio rodyklę</option>
        <option value="↶">Suktis prieš laikrodžio rodyklę</option>
        <option value="🎲">Mesti kauliuką</option>
        <option value="🚩">Pažymėti</option>
    </select>
    Rodyklė:
    <select id="conditioning">
        <option value="">Besąlygiška</option>
        <option value="Obstacle">Tik priešais kliūtį</option>
        <option value="Path">Tik priešais kelią</option>
        <option value="Food">Tik priešais maistą</option>
        <option value="Flag">Tik priešais žymę</option>
        <option value="0">Tik jei iškritusi 1 akis</option>
        <option value="1">Tik jei iškritę 2 akys</option>
        <option value="2">Tik jei iškritę 3 akys</option>
        <option value="3">Tik jei iškritę 4 akys</option>
        <option value="4">Tik jei iškritę 5 akys</option>
        <option value="5">Tik jei iškritę 6 akys</option>
    </select>
    Lėtinimas, ms:
    <input type="number" id="speed" value="1000" style="width: 4em;">
    Kauliukas:
    <span id="dice">⚀</span>
    <br>
    <canvas id="turtle-canvas" height="200" width="200"></canvas>
    <canvas id="canvas" height="450" width="1000"></canvas>
    <script type="text/javascript">
        var canvas = document.getElementById('canvas');
        var turtleCanvas = document.getElementById('turtle-canvas');
        var ctx = canvas.getContext('2d');
        var bubbles = [];
        var dragging = false;
        var source = null;
        var target = null;
        var lines = [];
        var label = '';
        var movement = 0;
        var time;
        var turtle = {x: 4, y: 2, direction: 2};
        var directions = [
            {x: 1, y: 0},
            {x: 0, y: 1},
            {x: -1, y: 0},
            {x: 0, y: -1}
        ];
        var arrows = ['▼', '▶', '▲', '◀'];
        var env = [
            '##########',
            '#...#...F#',
            '#...#....#',
            '#...#....#',
            '#...#....#',
            '#...###..#',
            '#.....#..#',
            '#.#####..#',
            '#........#',
            '##########'
        ];
        var flagged = [
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false],
            [false, false, false, false, false, false, false, false, false, false]
        ];
        var grid = [];
        var speed = 1000;

        var admits = function(condition) {
            var x = turtle.x + directions[turtle.direction].x;
            var y = turtle.y + directions[turtle.direction].y;
            var result =
                (condition == '') ||
                (condition == 'Path' && grid[x][y] == '.') ||
                (condition == 'Food' && grid[x][y] == 'F') ||
                (condition == 'Obstacle' && grid[x][y] == '#') ||
                (condition == 'Flag' && flagged[x][y]) ||
                (condition == dice);
            return result;
        };

        var dice = 0;
        var diceFaces = '⚀⚁⚂⚃⚄⚅';

        var rollDice = function() {
            dice = parseInt(Math.random() * 6);
            document.getElementById('dice').innerHTML = diceFaces[dice];
        };

        var commands = function(all) {
            if (all.length == 0) {
                return;
            }
            for (k in all) {
                var c = all[k];
                if (c == '➠') {
                    turtle.x += directions[turtle.direction].x;
                    turtle.y += directions[turtle.direction].y;
                }
                if (c == '↷') {
                    turtle.direction = (turtle.direction + 3) % 4;
                }
                if (c == '↶') {
                    turtle.direction = (turtle.direction + 1) % 4;
                }
                if (c == '🎲') {
                    rollDice();
                }
                if (c == '🚩') {
                    flagged[turtle.x][turtle.y] = true;
                }
            }
            drawTurtle();
        };

        var drawTurtle = function() {
            grid = [];
            for (k in env) {
                grid.push([]);
                for (j in env[k]) {
                    grid[k].push(env[k][j]);
                }
            }
            if (env[turtle.x][turtle.y] != '.') {
                canvas.setAttribute('class', 'error');
                return;
            }
            grid[turtle.x][turtle.y] = 'T';
            drawGrid();
        };

        var drawGrid = function() {
            var tctx = turtleCanvas.getContext('2d');
            tctx.clearRect(0, 0, 200, 200);
            var x = 0, y = 0;
            for (k in grid) {
                x = 0;
                for (j in grid[k]) {
                    switch (grid[k][j]) {
                        case '#':
                            tctx.fillStyle = '#740';
                            break;
                        case '.':
                            tctx.fillStyle = '#380';
                            break;
                        case 'T':
                            tctx.fillStyle = '#380';
                            break;
                        case 'F':
                            tctx.fillStyle = '#CC0';
                            break;
                    }
                    tctx.fillRect(x, y, 20, 20);
                    if (flagged[k][j]) {
                        tctx.fillStyle = 'white';
                        tctx.font = '15px sans-serif';
                        tctx.fillText('🚩', x, y + 17);
                    }
                    if (grid[k][j] == 'T') {
                        tctx.fillStyle = 'white';
                        tctx.font = '20px sans-serif';
                        tctx.fillText(arrows[turtle.direction], x, y + 17);
                    }
                    x += 20;
                }
                y += 20;
            }
        };

        var drawLine = function(source, target, condition) {
            ctx.beginPath();
            var d = {x: bubbles[target].x - bubbles[source].x, y: bubbles[target].y - bubbles[source].y};
            var dl = Math.sqrt(Math.pow(d.x, 2) + Math.pow(d.y, 2));
            d.x /= dl;
            d.y /= dl;
            ctx.strokeStyle = '#999';
            ctx.moveTo(bubbles[source].x + d.x * bubbles[source].radius, bubbles[source].y + d.y * bubbles[source].radius);
            ctx.lineTo(bubbles[target].x - d.x * (bubbles[target].radius + 15), bubbles[target].y - d.y * (bubbles[target].radius + 15));
            ctx.stroke();
            ctx.beginPath();
            ctx.save();
            ctx.translate(bubbles[target].x - d.x * bubbles[target].radius, bubbles[target].y - d.y * bubbles[target].radius);
            ctx.rotate(Math.atan(d.y / d.x) + ((d.x >= 0) ? 90 : -90) * Math.PI / 180);
            ctx.moveTo(0, 0);
            ctx.lineTo(5, 15);
            ctx.lineTo(-5, 15);
            ctx.closePath();
            ctx.restore();
            ctx.fill();
            var x = parseInt((bubbles[source].x + bubbles[target].x) / 2);
            var y = parseInt((bubbles[source].y + bubbles[target].y) / 2);
            if (condition == 'Obstacle' || condition == 'Path' || condition == 'Food') {
                ctx.fillStyle = {'Obstacle': '#740', 'Path': '#380', 'Food': '#CC0'}[condition];
                ctx.fillRect(x - 10, y - 10, 20, 20);
            }
            if (condition == '0' || parseInt(condition) > 0) {
                ctx.fillStyle = '#CCC';
                ctx.fillRect(x - 10, y - 10, 20, 20);
                ctx.font = '20px sans-serif';
                ctx.fillStyle = '#333';
                ctx.fillText(diceFaces[parseInt(condition)], x, y + 7);
            }
            if (condition == 'Flag') {
                ctx.font = '15px sans-serif';
                ctx.fillText('🚩', x, y + 5);
            }
        };

        var mouseUp = function(event) {
            event.preventDefault();
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            if (Date.now() - time > 500 && movement < 5) {
                execute(locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop));
                return false;
            }
            if (dragging) {
                target = null;
                target = locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop);
                if (target !== null && target != source) {
                    drawLine(source, target, document.getElementById('conditioning').value);
                    lines.push([source, target, document.getElementById('conditioning').value]);
                }
            }
            source = null;
            target = null;
            dragging = false;
            return false;
        };

        var mouseMove = function(event) {
            event.preventDefault();
            movement++;
            if (dragging) {

            }
            return false;
        };

        var drawBubbles = function(selection) {
            for (var j in bubbles) {
                ctx.beginPath();
                ctx.ellipse(bubbles[j].x, bubbles[j].y, bubbles[j].radius, bubbles[j].radius, 0, 0, 2 * Math.PI);
                //ctx.rect(bubbles[j].x - 25, bubbles[j].y - 25, 50, 50);
                ctx.fillStyle = bubbles[j].color.replace('?', selection == j ? '0.9' : '0.3');
                ctx.fill();
                ctx.font = '22px sans-serif';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                ctx.textAlign = 'center';
                ctx.fillText(bubbles[j].label, bubbles[j].x, bubbles[j].y + 7);
            }
            for (var j in lines) {
                drawLine(lines[j][0], lines[j][1], lines[j][2]);
            }
        };

        var shouldInhibitSpawning = function(x, y) {
            for (var k in bubbles) {
                if (Math.pow(bubbles[k].x - x, 2) + Math.pow(bubbles[k].y - y, 2) <= Math.pow(bubbles[k].radius + 25, 2)) {
                    return true;
                }
            }
            return false;
        };

        var locate = function(x, y) {
            for (var k in bubbles) {
                if (Math.pow(bubbles[k].x - x, 2) + Math.pow(bubbles[k].y - y, 2) <= Math.pow(bubbles[k].radius + 10, 2)) {
                    return k;
                }
            }
            return null;
        };

        var clear = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        var mouseDown = function(event) {
            event.preventDefault();
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            clear();
            movement = 0;
            time = Date.now();
            var x = event.pageX - canvas.offsetLeft;
            var y = event.pageY - canvas.offsetTop;
            var selection = locate(x, y);
            if (selection === null) {
                if (!shouldInhibitSpawning(x, y)) {
                    var color = 'rgba(' + Math.floor(Math.random() * 255) + ',' +
                             Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ', ?)';
                    bubbles.push({x: event.pageX - canvas.offsetLeft, y: event.pageY - canvas.offsetTop, radius: 25, color: color, label: label});
                    selection = bubbles.length - 1;
                }
            }
            drawBubbles(selection);
            dragging = true;
            source = selection;
            return false;
        };

        canvas.addEventListener('mousedown', mouseDown);
        canvas.addEventListener('touchstart', mouseDown);

        canvas.addEventListener('mouseup', mouseUp);
        canvas.addEventListener('touchend', mouseUp);

        canvas.addEventListener('mousemove', mouseMove);
        canvas.addEventListener('touchmove', mouseMove);

        var growing;
        var shrinking;

        var beginPulsation = function(ids) {
            for (k in ids) {
                endPulsation(ids[k]);
            }
            if (ids.length == 0) {
                return;
            }
            var grow = function() {
                for (k in ids) {
                    var id = ids[k];
                    bubbles[id].radius += 1;
                    if (bubbles[id].radius > 35) {
                        window.clearInterval(growing);
                        shrinking = window.setInterval(shrink, 20);
                        break;
                    }
                }
                clear();
                drawBubbles();
            };
            var shrink = function() {
                for (k in ids) {
                    var id = ids[k];
                    bubbles[id].radius -= 1;
                    if (bubbles[id].radius < 25) {
                        window.clearInterval(shrinking);
                        growing = window.setInterval(grow, 20);
                        break;
                    }
                }
                clear();
                drawBubbles();
            };
            growing = window.setInterval(grow, 10);
        };

        var endPulsation = function() {
            for (var k in bubbles) {
                bubbles[k].radius = 25;
            }
            window.clearInterval(growing);
            window.clearInterval(shrinking);
        };

        var currentStates = [];

        var execution;

        var execute = function(id) {
            window.clearInterval(execution);
            currentStates = [[id, '']];
            var doExecution = function() {
                endPulsation();
                var admissibleStates = [];
                for (k in currentStates) {
                    if (admits(currentStates[k][1])) {
                        admissibleStates.push(currentStates[k][0]);
                    }
                }
                currentStates = admissibleStates;
                if (currentStates.length > 1) {
                    //canvas.setAttribute('class', 'error');
                    clear();
                    drawBubbles();
                    window.clearInterval(execution);
                    window.alert('Paspaudimas negali persiduoti keliems mygtukams iš karto.');
                    return;
                }
                if (currentStates.length == 0) {
                    clear();
                    drawBubbles();
                    window.clearInterval(execution);
                    return;
                }
                var futureStates = [];
                beginPulsation(currentStates);
                var cmds = [];
                for (k in currentStates) {
                    cmds.push(bubbles[currentStates[k]].label);
                    for (j in lines) {
                        if (lines[j][0] === currentStates[k]) {
                            futureStates.push([lines[j][1], lines[j][2]]);
                        }
                    }
                }
                commands(cmds);
                currentStates = futureStates;
            };
            doExecution();
            execution = window.setInterval(doExecution, speed);
        };

        canvas.addEventListener('dblclick', function(event) {
            if ('changedTouches' in event) {
                event.pageX = event.changedTouches[0].pageX;
                event.pageY = event.changedTouches[0].pageY;
            }
            execute(locate(event.pageX - canvas.offsetLeft, event.pageY - canvas.offsetTop));
            return false;
        });

        var action = document.getElementById('action');

        action.addEventListener('change', function() {
            label = action.value;
        });

        var speedSwitch = document.getElementById('speed');

        speedSwitch.addEventListener('blur', function() {
            speed = parseInt(speedSwitch.value);
        });

        document.addEventListener('keypress', function() {
            window.clearInterval(execution);
            endPulsation();
            clear();
            drawBubbles();
        });

        drawTurtle();
    </script>
</body>
</html>
